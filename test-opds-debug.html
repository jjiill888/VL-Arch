<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPDSå°é¢è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .book-card { border: 1px solid #ddd; margin: 10px; padding: 15px; border-radius: 8px; }
        .cover-image { max-width: 120px; max-height: 180px; object-fit: cover; }
        .link-list { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .found-cover { background-color: #e8f5e8; border-color: #4caf50; }
        .no-cover { background-color: #ffe8e8; border-color: #f44336; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        .stats { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .cover-test { display: flex; gap: 15px; align-items: flex-start; }
        .cover-test img { border: 2px solid #4caf50; border-radius: 4px; }
        .error-img { border-color: #f44336 !important; }
    </style>
</head>
<body>
    <h1>ğŸ” OPDSå°é¢è°ƒè¯•å·¥å…·</h1>

    <div class="stats">
        <h3>è¿æ¥ä¿¡æ¯</h3>
        <p><strong>OPDS URL:</strong> http://server.15110y.top:8083/opds</p>
        <p><strong>ç”¨æˆ·å:</strong> reader01</p>
        <p><strong>çŠ¶æ€:</strong> <span id="connection-status">æœªè¿æ¥</span></p>
    </div>

    <button onclick="testOPDSCovers()">ğŸ§ª æµ‹è¯•OPDSå°é¢</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>

    <div id="results"></div>

    <script>
        async function testOPDSCovers() {
            const OPDS_URL = 'http://server.15110y.top:8083/opds';
            const credentials = {
                username: 'reader01',
                password: '123456'
            };

            const resultsDiv = document.getElementById('results');
            const statusSpan = document.getElementById('connection-status');

            statusSpan.textContent = 'è¿æ¥ä¸­...';
            statusSpan.style.color = 'orange';

            resultsDiv.innerHTML = '<p>æ­£åœ¨è·å–OPDSæ•°æ®...</p>';

            try {
                // åˆ›å»ºBasic Auth header
                const auth = btoa(`${credentials.username}:${credentials.password}`);

                // è·å–OPDS feed
                const response = await fetch(OPDS_URL, {
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Accept': 'application/atom+xml, application/xml, text/xml'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const xmlText = await response.text();
                statusSpan.textContent = 'å·²è¿æ¥';
                statusSpan.style.color = 'green';

                // è§£æXML
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlText, 'text/xml');

                // æ£€æŸ¥è§£æé”™è¯¯
                const parserError = doc.querySelector('parsererror');
                if (parserError) {
                    throw new Error(`XMLè§£æé”™è¯¯: ${parserError.textContent}`);
                }

                // æŸ¥æ‰¾æ‰€æœ‰entryå…ƒç´ 
                const entries = doc.querySelectorAll('entry');
                let coverCount = 0;
                let totalBooks = entries.length;

                resultsDiv.innerHTML = `
                    <div class="stats">
                        <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                        <p><strong>æ€»ä¹¦ç±æ•°:</strong> ${totalBooks}</p>
                        <p><strong>æœ‰å°é¢:</strong> <span id="cover-count">è®¡ç®—ä¸­...</span></p>
                        <p><strong>æ— å°é¢:</strong> <span id="no-cover-count">è®¡ç®—ä¸­...</span></p>
                        <p><strong>å°é¢ç‡:</strong> <span id="cover-percentage">è®¡ç®—ä¸­...</span></p>
                    </div>
                    <div id="book-list"></div>
                `;

                const bookListDiv = document.getElementById('book-list');

                // æ£€æŸ¥æ¯ä¸ªentryçš„å°é¢é“¾æ¥
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    const title = entry.querySelector('title')?.textContent || 'æœªçŸ¥æ ‡é¢˜';
                    const links = entry.querySelectorAll('link');

                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';

                    let foundCover = null;
                    const coverRels = [
                        'http://opds-spec.org/image',
                        'http://opds-spec.org/cover',
                        'http://opds-spec.org/image/thumbnail',
                        'http://opds-spec.org/thumbnail',
                        'cover',
                        'thumbnail'
                    ];

                    const imageTypes = [
                        'image/jpeg',
                        'image/jpg',
                        'image/png',
                        'image/gif',
                        'image/webp'
                    ];

                    const allLinks = [];

                    // æ£€æŸ¥æ‰€æœ‰é“¾æ¥
                    links.forEach(link => {
                        const rel = link.getAttribute('rel');
                        const type = link.getAttribute('type');
                        const href = link.getAttribute('href');

                        allLinks.push({ rel, type, href });

                        // ç­–ç•¥1: æ£€æŸ¥relå±æ€§
                        if (!foundCover && coverRels.includes(rel)) {
                            foundCover = { rel, type, href, strategy: 'OPDS rel' };
                        }

                        // ç­–ç•¥2: æ£€æŸ¥MIMEç±»å‹
                        if (!foundCover && imageTypes.includes(type)) {
                            foundCover = { rel, type, href, strategy: 'MIME type' };
                        }

                        // ç­–ç•¥3: æ£€æŸ¥URLåŒ…å«å…³é”®è¯
                        if (!foundCover && href && (
                            href.toLowerCase().includes('cover') ||
                            href.toLowerCase().includes('thumb') ||
                            href.toLowerCase().includes('image')
                        )) {
                            foundCover = { rel, type, href, strategy: 'heuristic' };
                        }
                    });

                    if (foundCover) {
                        coverCount++;
                        bookCard.classList.add('found-cover');
                        bookCard.innerHTML = `
                            <div class="cover-test">
                                <div>
                                    <img class="cover-image"
                                         src="${foundCover.href}"
                                         alt="${title}"
                                         onerror="this.classList.add('error-img'); this.nextElementSibling.style.display='block';"
                                         onload="console.log('âœ… å°é¢åŠ è½½æˆåŠŸ: ${title}');">
                                    <p style="display:none; color:red;">âŒ å°é¢åŠ è½½å¤±è´¥</p>
                                </div>
                                <div>
                                    <h4>ğŸ“– ${title}</h4>
                                    <p><strong>ç­–ç•¥:</strong> ${foundCover.strategy}</p>
                                    <p><strong>å°é¢URL:</strong> <a href="${foundCover.href}" target="_blank">${foundCover.href}</a></p>
                                    <p><strong>rel:</strong> ${foundCover.rel || 'N/A'}</p>
                                    <p><strong>type:</strong> ${foundCover.type || 'N/A'}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        bookCard.classList.add('no-cover');
                        bookCard.innerHTML = `
                            <h4>ğŸ“– ${title}</h4>
                            <p><strong>çŠ¶æ€:</strong> âŒ æœªæ‰¾åˆ°å°é¢</p>
                            <div class="link-list">
                                <strong>å¯ç”¨é“¾æ¥:</strong>
                                ${allLinks.map(link => `
                                    <br>â€¢ rel: ${link.rel || 'N/A'}, type: ${link.type || 'N/A'}, href: ${link.href ? link.href.substring(0, 80) + (link.href.length > 80 ? '...' : '') : 'N/A'}
                                `).join('')}
                            </div>
                        `;
                    }

                    bookListDiv.appendChild(bookCard);
                }

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const noCoverCount = totalBooks - coverCount;
                const coverPercentage = totalBooks > 0 ? Math.round((coverCount / totalBooks) * 100) : 0;

                document.getElementById('cover-count').textContent = coverCount;
                document.getElementById('no-cover-count').textContent = noCoverCount;
                document.getElementById('cover-percentage').textContent = `${coverPercentage}%`;

                console.log(`ğŸ“Š æ€»ç»“: ${totalBooks} æœ¬ä¹¦, ${coverCount} æœ‰å°é¢ (${coverPercentage}%)`);

            } catch (error) {
                statusSpan.textContent = 'è¿æ¥å¤±è´¥';
                statusSpan.style.color = 'red';
                resultsDiv.innerHTML = `
                    <div class="stats" style="background-color: #ffebee;">
                        <h3>âŒ é”™è¯¯</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <p><strong>å¯èƒ½åŸå› :</strong></p>
                        <ul>
                            <li>OPDSæœåŠ¡å™¨æ— æ³•è®¿é—®</li>
                            <li>è®¤è¯ä¿¡æ¯é”™è¯¯</li>
                            <li>CORSç­–ç•¥é™åˆ¶</li>
                            <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                        </ul>
                        <p><strong>å»ºè®®:</strong> è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€</p>
                    </div>
                `;
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('connection-status').textContent = 'æœªè¿æ¥';
            document.getElementById('connection-status').style.color = 'gray';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            console.log('ğŸ”§ OPDSå°é¢è°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('ç‚¹å‡»"æµ‹è¯•OPDSå°é¢"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>